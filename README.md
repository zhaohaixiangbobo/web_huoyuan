# 卷烟货源分配平台

一个基于 FastAPI + React + Ant Design Pro 的卷烟货源分配优化平台，支持Excel数据导入、约束配置、线性规划求解和结果导出。

## 功能特性

### 核心功能
- **Excel数据导入**: 支持 .xlsx 和 .xls 格式的Excel文件上传
- **模板下载**: 提供标准Excel模板文件下载，确保数据格式正确
- **约束条件配置**: 灵活配置需求、投放量、价格、C类烟等约束条件
- **目标函数设置**: 支持最大化分配量、最小化成本、均衡分配等多目标优化
- **线性规划求解**: 基于PuLP库的高效线性规划算法
- **结果可视化**: 直观的分配结果展示和统计分析
- **数据导出**: 支持Excel和CSV格式的结果导出
- **统计表导出**: 专门的分配结果统计表导出功能，包含详细的统计分析数据

### 技术特性
- **前后端分离**: FastAPI后端 + React前端
- **现代化UI**: 基于Ant Design Pro的响应式界面
- **实时计算**: 异步任务处理，支持复杂计算场景
- **数据验证**: 完整的数据格式和约束条件验证
- **错误处理**: 友好的错误提示和异常处理

## 技术栈

### 后端
- **FastAPI**: 现代化的Python Web框架
- **PuLP**: 线性规划求解库
- **Pandas**: 数据处理和分析
- **OpenPyXL**: Excel文件读写
- **Uvicorn**: ASGI服务器

### 前端
- **React 18**: 现代化的前端框架
- **Ant Design**: 企业级UI组件库
- **Axios**: HTTP客户端
- **React Router**: 前端路由管理

## 项目结构

```
web_huoyuan/
├── backend/                    # 后端代码
│   ├── main.py                # FastAPI主应用
│   ├── models.py              # Pydantic数据模型
│   ├── constraint_manager.py  # 约束管理器
│   ├── data_loader.py         # 数据加载器
│   ├── linear_programming.py  # 线性规划求解器
│   └── requirements.txt       # Python依赖
├── frontend/                   # 前端代码
│   ├── public/                # 静态资源
│   ├── src/                   # 源代码
│   │   ├── pages/             # 页面组件
│   │   │   ├── HomePage.js    # 首页 - 数据导入与配置
│   │   │   ├── AllocationPage.js # 分配明细页面
│   │   │   ├── StatisticsPage.js # 结果统计页面
│   │   │   └── ResultPage.js  # 计算结果页面
│   │   ├── services/          # API服务
│   │   │   └── api.js         # API接口封装
│   │   ├── App.js             # 主应用组件
│   │   ├── index.js           # 应用入口
│   │   └── index.css          # 全局样式
│   └── package.json           # Node.js依赖
├── huoyuanfenpei.xlsx         # 示例数据文件
└── README.md                  # 项目说明文档
```

## 安装和运行

### 环境要求
- Python 3.8+
- Node.js 16+
- npm 或 yarn

### 后端安装
```bash
cd backend
pip install -r requirements.txt
```

### 前端安装
```bash
cd frontend
npm install
```

### 启动应用

#### 启动后端服务
```bash
cd backend
python main.py
```
后端服务将在 http://localhost:8000 启动

#### 启动前端服务
```bash
cd frontend
npm start
```
前端应用将在 http://localhost:3000 启动

## 使用指南

### 1. 数据准备
准备包含以下信息的Excel文件：
- **Sheet1 (分配数据)**: 产品代码、产品名称、各轮次需求量等
- **Sheet2 (控制要求)**: 投放总量、单箱均价等约束条件

**提示**: 可以在首页点击"下载模板"按钮获取标准格式的Excel模板文件

### 2. 数据导入
1. 在首页点击或拖拽上传Excel文件
2. 系统自动验证数据格式和完整性
3. 显示产品数量、轮次信息等基本统计

### 3. 配置约束条件
- **基础约束**: 需求满足、投放总量、单箱均价、C类烟、分配均衡
- **容差设置**: 投放总量容差、价格容差
- **目标函数**: 最大化分配量、最小化成本、均衡分配权重

### 4. 执行计算
1. 点击"开始计算"按钮
2. 系统使用线性规划算法求解最优分配方案
3. 显示求解状态、目标函数值、分配率等结果

### 5. 查看结果
- **分配明细页面**: 查看每个产品的详细分配情况
- **结果统计页面**: 查看各轮次和总计的统计分析数据，支持导出"分配结果统计表"
- **计算结果页面**: 查看汇总统计和约束验证结果
- **数据导出**: 支持Excel和CSV格式导出分配明细和统计表

## API接口

### 后端API
- `POST /api/upload`: 上传Excel文件
- `GET /api/download-template`: 下载Excel模板文件
- `POST /api/solve`: 提交计算配置并求解
- `GET /api/result`: 获取计算结果
- `GET /api/constraints`: 获取约束验证结果
- `GET /api/export`: 导出计算结果
- `GET /api/export-statistics`: 导出分配结果统计表

### 前端路由
- `/`: 首页 - 数据导入与计算配置
- `/allocation`: 分配明细查看 & 导出
- `/statistics`: 结果统计分析
- `/result`: 计算结果汇总

## 核心算法

### 约束条件
1. **需求约束**: 每个产品的总分配量等于需求量
2. **投放量约束**: 每轮次投放总量在指定范围内
3. **价格约束**: 每轮次单箱均价在指定范围内
4. **C类烟约束**: C类烟分配量不超过总量的40%，且不超过4900箱
5. **均衡约束**: 各轮次分配尽量均衡

### 目标函数
- **最大化分配量**: 优先满足更多产品的需求
- **最小化成本**: 优先分配低价产品
- **均衡分配**: 各轮次分配量尽量平衡

## 数据格式说明

### Excel文件格式
**Sheet1 (分配数据)**:
| 产品代码 | 产品名称 | 轮次1 | 轮次2 | ... | 单箱价格 |
|---------|---------|-------|-------|-----|---------|
| P001    | 产品A   | 100   | 150   | ... | 45.50   |

**Sheet2 (控制要求)**:
| 轮次 | 投放总量下限 | 投放总量上限 | 单箱均价下限 | 单箱均价上限 |
|------|-------------|-------------|-------------|-------------|
| 1    | 1000        | 1200        | 40.00       | 50.00       |

## 开发说明

### 添加新功能
1. 后端: 在 `main.py` 中添加新的API端点
2. 前端: 在 `services/api.js` 中添加对应的API调用
3. 更新相关页面组件和路由配置

### 自定义约束
1. 在 `constraint_manager.py` 中添加新的约束验证方法
2. 在 `linear_programming.py` 中实现对应的约束条件
3. 更新前端配置界面

### 扩展目标函数
1. 在 `linear_programming.py` 中修改 `create_objective_function` 方法
2. 更新前端目标函数配置选项

## 常见问题

### Q: 上传文件失败
A: 请检查文件格式是否为.xlsx或.xls，确保文件包含必要的Sheet1和Sheet2

### Q: 计算结果为非最优解
A: 可能是约束条件过于严格，尝试调整容差参数或放宽部分约束

### Q: 导出功能异常
A: 确保已完成计算且有有效结果，检查浏览器是否允许文件下载

## 许可证

本项目采用 MIT 许可证。

## 更新日志

### v2.3.0 (2025-01-25)
**新增结果统计分析功能**

#### 新增功能
- **结果统计页面**: 新增专门的结果统计分析页面，提供全面的分配结果统计
  - **基础统计指标**: 
    - 单箱：各轮次和总计的单箱均价（加权平均）
    - 总量：总分配量（保留两位小数）
    - 总数：投放大于0的品规数量
    - C类量：C列有值的分配量
    - 占比：C类量/总量的百分比
    - C类数：C类投放大于0的品规数量
  - **分类统计**: 
    - 方块量/数：方块类型的分配量和数量
    - 长片量/数：长片类型的分配量和数量
    - 细支量/数：细支类型的分配量和数量
  - **数据来源**: 所有统计数据从 `allocation_details` 中计算得出，包括各轮次分配量、总分配量、单箱价格、C类标识等

#### 界面优化
- **美观的统计表格**: 
  - 支持横向滚动的动态表格
  - 渐变色背景和阴影效果
  - 清晰的指标说明和分类统计
  - 响应式布局设计
- **导航菜单更新**: 在主导航中新增"结果统计分析"菜单项
- **路由配置**: 新增 `/statistics` 路由，完善页面导航体系

#### 技术特点
- **动态列生成**: 根据实际轮次数据动态生成表格列
- **数据计算逻辑**: 完整的统计指标计算逻辑，支持各种分类统计
- **React Hooks优化**: 使用 `useCallback` 优化性能，避免不必要的重渲染
- **错误处理**: 完善的加载状态和错误处理机制
- **代码质量**: 无警告的高质量代码，遵循React最佳实践

#### 文档更新
- 更新项目结构说明，添加 `StatisticsPage.js` 文件
- 更新前端路由说明，添加结果统计页面路由
- 更新使用指南，添加结果统计页面的使用说明

### v1.2.0 (2024-12-19)
**功能改进**
- ✅ **前端联动功能优化**: 修复了约束配置和目标函数的开关联动问题
  - 为Form组件添加了完整的initialValues配置
  - 修复了Switch组件状态未正确传递给Form状态管理系统的问题
  - 实现了开关关闭时对应参数设为null的逻辑
- ✅ **后端约束验证优化**: 实现了基于前端配置的有条件约束验证
  - 根据constraint_config中的开关状态决定是否验证对应约束
  - 跳过用户已禁用的约束条件验证，提高验证效率
  - 增加了约束验证的日志记录和摘要信息

**技术改进**
- 优化了前后端数据传递机制
- 改进了约束管理器的验证逻辑
- 增强了用户体验和系统稳定性

### v2.2.0 (2025-01-24)
**轮次约束配置架构重构**

#### 重大架构改进
- **轮次约束配置重构**: 将价格和投放量约束从单值配置改为按轮次分配的字典配置
  - `price_upper_limit` → `price_upper_limits`: 支持为每个轮次单独设置价格上限
  - `price_lower_limit` → `price_lower_limits`: 支持为每个轮次单独设置价格下限
  - `volume_limits`: 完善按轮次配置投放总量限制的功能

#### 前端界面重构
- **新增轮次约束配置区域**: 
  - 动态生成每个轮次的约束配置表单
  - 支持为每个轮次独立设置价格上限、价格下限和投放总量限制
  - 提供默认值提示和输入验证
- **表单数据处理优化**:
  - 改进 `handleSolve` 函数，支持轮次约束数据的收集和组织
  - 自动过滤空值，只传递有效的约束配置
  - 兼容新的字典格式约束参数

#### 后端模型更新
- **数据模型重构**: 
  - 更新 `ConstraintConfig` 类，支持按轮次分配的约束参数
  - 字段类型从 `Optional[float]` 改为 `Optional[Dict[str, float]]`
  - 保持向后兼容性，支持旧格式数据
- **约束处理逻辑优化**:
  - 改进 `data_loader.py` 中的约束更新逻辑
  - 支持字典格式和单值格式的兼容处理
  - 优化约束检测和应用机制

#### 配置一致性改进
- **目标函数配置统一**: 更新 `linear_programming.py` 中的默认目标函数配置，与 `models.py` 中的 `ObjectiveConfig` 类保持完全一致
  - 统一使用新的权重配置格式：`maximize_allocation_weight`、`round_balance_weight`、`round_variance_weight`、`product_balance_weight`、`smooth_transition_weight`
  - 移除旧的配置格式，确保前后端配置参数的一致性

#### 动态容差配置优化
- **容差参数动态化**: 移除硬编码的0.5%容差，改为根据 `constraint_config` 中的 `volume_tolerance` 参数动态设置
- **约束管理器改进**: 
  - `ConstraintManager` 构造函数支持接收 `constraint_config` 参数
  - `reset_round_constraints` 方法支持动态更新容差配置
  - 投放总量约束的上下限根据配置的容差动态计算
- **求解流程优化**: 在求解时重新创建 `constraint_manager`，确保使用最新的约束配置

#### ConstraintManager重构优化
- **约束参数动态化**: 重构 `ConstraintManager` 类，支持两套逻辑：
  - **默认固定参数**: 使用系统默认的约束参数值
  - **动态配置参数**: 根据 `constraint_config` 动态设置约束参数
- **参数统一管理**: 
  - 新增 `_init_constraint_parameters()` 方法，统一初始化所有约束参数
  - 支持动态配置：`volume_tolerance`、`price_based_ratio`、`c_type_ratio`、`c_type_volume_limit`、`chang_type_ratio`、`chang_type_volume_limit`、`xi_type_ratio`、`xi_type_volume_limit`
  - **新增轮次级别约束参数**: `price_upper_limits`、`price_lower_limits`、`volume_limits`，支持按轮次覆盖默认约束值
  - 移除硬编码值，所有约束参数均可通过配置动态调整
- **约束验证逻辑优化**:
  - 更新 `validate_price_constraints()` 方法，优先使用轮次级别的价格约束参数
  - 更新 `validate_volume_constraints()` 方法，优先使用轮次级别的投放量约束参数
  - 实现动态约束覆盖机制，提高约束验证的灵活性
- **线性规划求解器同步**: 
  - 更新 `linear_programming.py` 中的约束实现，从 `constraint_manager` 获取动态配置参数
  - C类烟约束、按价品规约束等均使用动态参数
  - **完善轮次约束支持**: `add_average_price_constraints()` 和 `add_volume_constraints()` 方法优先使用轮次级别约束参数
  - 确保约束验证和求解使用相同的参数配置
- **配置更新机制**: 
  - 改进 `update_config()` 方法，支持全量参数更新
  - 在求解时通过 `update_config()` 方法应用最新配置
  - 保持配置的一致性和实时性
- **关键逻辑修复**: 
  - **修复约束初始化逻辑**: 修正 `__init__` 方法中的约束参数初始化逻辑，确保当存在 `constraint_config` 时优先使用配置值覆盖默认值
  - **修复容差计算错误**: 修正 `total_lower` 计算中的错误，从 `(1 + volume_tolerance)` 改为正确的 `(1 - volume_tolerance)`
  - **优先级机制完善**: 实现完整的约束参数优先级机制：配置值 > 默认值，确保动态约束的正确应用
- **代码架构优化**:
  - **约束更新逻辑重构**: 将 `data_loader` 约束更新逻辑从 `linear_programming.py` 移动到 `main.py` 中，在创建 `constraint_manager` 之前执行，确保逻辑顺序的合理性
  - **移除重复代码**: 移除 `linear_programming.py` 中重复的 `constraint_manager.reset_round_constraints()` 调用，因为在 `main.py` 中已重新创建 `constraint_manager`
  - **流程优化**: 优化约束配置的处理流程：`data_loader` 更新 → 创建 `constraint_manager` → 执行求解，确保各组件使用一致的约束配置

#### 用户界面优化
- **约束配置UI重构**: 
  - **基础约束布局优化**: 将基础约束从2行布局改为每行3个，提高界面紧凑性
  - **约束配置参数重组**: 将分散的约束配置参数重新组织为独立的"约束配置参数"区域，每行3个配置项
  - **约束关联机制**: 实现约束配置项与启用项的关联，启用时可编辑，禁用时不可编辑，提高用户体验
  - **轮次约束默认值**: 为轮次约束配置添加默认值填充，使用 `initialValue` 属性自动填充数据文件中的默认约束值
- **配置项分类优化**:
  - 基础约束：8个约束开关，每行3个，共3行布局
  - 约束配置参数：投放总量容差、按价比例、C类烟相关参数等，每行3个，共3行布局
  - 轮次约束配置：每个轮次的价格上下限和投放总量，每行3个配置项
- **交互体验改进**:
  - 约束配置项根据对应约束的启用状态动态启用/禁用
  - 提供清晰的配置项分组和标题
  - 保持一致的布局风格和间距
- **默认状态修复**: 
  - **约束默认启用**: 修复所有约束配置项默认禁用的问题，现在所有约束默认启用状态
  - **表单初始化优化**: 添加 `useEffect` 钩子和 `key` 属性，确保表单初始值正确应用
  - **关联逻辑完善**: 确保约束配置参数与对应启用开关的关联逻辑正确工作

#### API接口更新
- **约束配置API**: 更新响应格式，使用新的字段名
- **数据验证**: 增强对轮次约束数据的验证和错误处理

#### 技术亮点
- **灵活的约束配置**: 支持为不同轮次设置不同的约束条件，满足复杂业务需求
- **向后兼容性**: 保持对旧版本单值配置的兼容支持
- **动态界面生成**: 根据数据中的轮次信息动态生成配置界面
- **数据完整性**: 完善的数据验证和错误处理机制
- **配置一致性**: 前后端配置参数完全统一，避免配置不匹配问题
- **动态容差**: 支持用户自定义投放总量容差，提高系统灵活性
- **约束参数可配置**: 所有约束参数均支持动态配置，提高系统灵活性和可维护性
- **用户体验优化**: 通过界面重构和关联机制，提供更直观、高效的配置体验

### v2.1.0 (2025-01-21)
**功能优化与约束管理增强**

#### 新增功能
- **长和细类型约束配置**: 新增对C类烟中"长"和"细"类型产品的独立约束配置
  - 长类比例：长类烟在每轮C类烟中的最大比例（默认20%）
  - 长类量限制：每轮长类烟的最大限制（默认1000箱）
  - 细类比例：细类烟在每轮C类烟中的最大比例（默认60%）
  - 细类量限制：每轮细类烟的最大限制（默认3000箱）

- **动态约束更新机制**: 支持通过API动态更新约束条件
  - 价格上下限动态调整
  - 投放总量限制动态调整
  - 约束缓存机制，提高性能

- **约束重置功能**: 每次求解前自动重置约束值，确保使用最新数据

#### 功能移除
- **价格容差配置**: 移除了价格容差设置，简化配置流程

#### 技术改进
- **约束管理器优化**: 
  - 添加 `reset_round_constraints()` 方法，支持约束值重置
  - 改进约束数据同步机制
- **数据加载器增强**:
  - 添加约束缓存机制 `round_constraints`
  - 新增 `update_round_constraints()` 和 `reload_constraints()` 方法
  - 支持动态约束更新
- **线性规划求解器改进**:
  - 完善默认配置参数
  - 添加约束更新检测逻辑
  - 优化求解前的数据准备流程

#### 界面更新
- 在C类烟配置区域新增长类和细类的比例及量限制配置项
- 移除价格容差配置界面
- 优化表单布局和用户体验

#### API更新
- 约束配置API支持新的长细类型参数
- 改进约束验证和错误处理机制

### v2.0.0 (2025-01-20)
**初始版本发布**
- 基础的卷烟货源分配功能
- Excel数据导入导出
- 线性规划求解
- 约束条件配置
- 结果可视化展示

### v1.0.0 (2024-01-XX)
- 初始版本发布
- 支持Excel数据导入和基础约束配置
- 实现线性规划求解和结果展示
- 提供数据导出功能